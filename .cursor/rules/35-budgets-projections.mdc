---
description: "USE WHEN implementando orçamentos, projeções, contribuições automáticas e validações de mínimo."
alwaysApply: false
---

# Orçamentos e Projeções

## Sistema Unificado

- **Orçamentos e projeções são a mesma coisa**: ambos usam a tabela `budgets` com campos `source_type` e `is_projected`.
- **Tipos de origem**: `manual`, `credit_card`, `goal`, `debt`, `recurring`, `installment`.
- **Projeções automáticas**: geradas a partir de faturas de cartão, objetivos, dívidas negociadas, transações recorrentes e parceladas.

## Contribuições Automáticas

### Inclusão no Orçamento

- **Goals**: Campo `include_in_budget` (padrão: `true`) + `contribution_frequency` + `monthly_contribution_cents`.
- **Debts**: Campo `include_in_budget` (padrão: `true`) + `contribution_frequency` + `monthly_payment_cents` (apenas para dívidas negociadas com `is_negotiated = true`).
- **Investments**: Campo `include_in_budget` (padrão: `true`) + `contribution_frequency` + `monthly_contribution_cents`.
- **Transactions**: Campo `contribution_frequency` para transações recorrentes (além de `recurrence_rule` para compatibilidade).

### Frequências de Aporte

Frequências suportadas: `daily`, `weekly`, `biweekly`, `monthly`, `quarterly`, `yearly`.

- **Cálculo mensal**: Função `calculateMonthlyTotal()` converte frequência em valor mensal.
- **Inclusão por mês**: Função `shouldIncludeInMonth()` determina se deve incluir em um mês específico baseado na frequência e data de início.

### Validação de Mínimo

- **Cálculo automático**: `minimum_amount_planned` = soma de todas as contribuições automáticas da categoria.
- **Fontes consideradas**:
  - Transações recorrentes da categoria
  - Goals com `include_in_budget = true`
  - Debts com `include_in_budget = true` e `is_negotiated = true`
  - Investments com `include_in_budget = true`
  - Faturas de cartão de crédito
- **Validação obrigatória**: Orçamento não pode ser reduzido abaixo de `minimum_amount_planned`.
- **Mensagem de erro**: Deve listar todas as fontes que impedem a redução e sugerir ações (ex: desmarcar transação como recorrente).

## Orçamentos Automáticos

### Geração Automática

- **Goals**: Quando `include_in_budget = true` e `status = 'active'`, gerar budgets automáticos para próximos 12 meses baseado em `monthly_contribution_cents` e `contribution_frequency`.
  - Se `target_date` fornecido, calcular automaticamente `monthly_contribution_cents` baseado em `(target_amount_cents - current_amount_cents) / meses_restantes`.
  - Usuário pode ajustar `monthly_contribution_cents` manualmente.
  - Budgets gerados têm `source_type = 'goal'` e `is_auto_generated = true`.

- **Debts**: Quando `is_negotiated = true`, `include_in_budget = true` e status é `'active'`, `'negotiating'` ou `'negociando'`, gerar budgets automáticos.
  - Se tem `installment_count` e `installment_amount_cents`, distribuir parcelas nos meses pertinentes baseado em `installment_day`.
  - Se tem `contribution_frequency` e `monthly_payment_cents`, gerar baseado na frequência.
  - Budgets gerados têm `source_type = 'debt'` e `is_auto_generated = true`.

- **Investments**: Quando `include_in_budget = true`, `status = 'active'` e tem `contribution_frequency` e `monthly_contribution_cents`, gerar budgets automáticos.
  - Gerar baseado na frequência de aporte.
  - Budgets gerados têm `source_type = 'investment'` e `is_auto_generated = true`.

- **Credit Cards**: Budgets gerados automaticamente via faturas. Bloquear criação manual completamente.

### Bloqueio de Criação/Edição Manual

- **Categorias automáticas**: Não permitir criação manual de budgets para categorias com `source_type` em `['credit_card', 'goal', 'debt', 'investment']`.
- **Budgets automáticos**: Não permitir edição manual de budgets com `is_auto_generated = true` (exceto goals via endpoint especial).
- **Mensagens de erro**: Explicar claramente que orçamentos são gerados automaticamente e devem ser ajustados através da entidade correspondente.

### Ajuste Manual de Budgets de Goals

- **Endpoint especial**: `POST /api/budgets/[id]/adjust-goal` permite ajustar budget de goal manualmente.
- **Recálculo automático**: Ao ajustar um budget de goal, recalcular todos os meses subsequentes baseado no novo valor.
- **Atualização do goal**: Atualizar `goal.monthly_contribution_cents` com o novo valor calculado, sobrescrevendo a regra original.

## Regras de Negócio

### Criação de Orçamentos

- Ao criar orçamento manual, calcular e definir `minimum_amount_planned` e `auto_contributions_cents`.
- Validar que `amount_planned >= minimum_amount_planned` antes de salvar.
- Se validação falhar, retornar erro com lista de fontes e sugestões.
- **Bloquear criação manual** para categorias automáticas (credit_card, goal, debt, investment).

### Atualização de Orçamentos

- Ao atualizar `amount_planned`, recalcular `minimum_amount_planned`.
- Validar que novo valor >= mínimo.
- Se tentar reduzir abaixo do mínimo, retornar erro específico com fontes que impedem.
- **Bloquear edição manual** de budgets com `is_auto_generated = true` (exceto goals via endpoint especial).

### Projeções Automáticas

- Geradas pelo serviço `generateProjections()` que consolida:
  - Faturas de cartão de crédito
  - Aportes de objetivos (com `include_in_budget` e frequência)
  - Pagamentos de dívidas negociadas (com `include_in_budget` e frequência)
  - Aportes de investimentos (com `include_in_budget` e frequência)
  - Transações recorrentes (com `contribution_frequency`)
  - Transações parceladas
- Projeções são transformadas em registros `budgets` com `is_projected = true`.

### Interface do Usuário

- **Formulários**: Todos devem incluir checkbox "Incluir no orçamento" (padrão: marcado) e select de frequência.
- **Validação visual**: Mostrar valor mínimo nos cards de orçamento quando há contribuições automáticas.
- **Mensagens de erro**: Explicar claramente por que não pode reduzir e listar fontes que impedem.

## Compatibilidade e Fallback

- **Migration não aplicada**: Código deve funcionar mesmo sem os novos campos (`minimum_amount_planned`, `auto_contributions_cents`).
- **Fallback**: Tentar inserir/atualizar com novos campos; se falhar com erro de coluna não encontrada, tentar sem eles.
- **Detecção de erro**: Verificar código `42703` (PostgreSQL undefined column) ou mensagem contendo nome da coluna.

## Performance

- **Cache**: Usar cache de projeções para evitar recálculos frequentes.
- **Índices**: Criar índices para queries de frequência e inclusão no orçamento:
  - `idx_goals_budget_inclusion`
  - `idx_debts_budget_inclusion`
  - `idx_investments_budget_inclusion`
  - `idx_transactions_recurring_frequency`
  - `idx_budgets_minimum`

## Validações Zod

- **Schemas**: Todos os schemas devem validar que `contribution_frequency` é obrigatório quando `include_in_budget = true`.
- **Debts**: Validar que `monthly_payment_cents` é obrigatório quando `include_in_budget = true`.
- **Transactions**: Validar que `contribution_frequency` é obrigatório quando `is_recurring = true`.
