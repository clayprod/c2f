import pg from 'pg';

const { Client } = pg;

const client = new Client({
  connectionString: 'postgresql://postgres:Hgcn2hpn**12@db.ndlqyqfxvlalootwdjxv.supabase.co:5432/postgres',
  ssl: { rejectUnauthorized: false }
});

async function runMigrations() {
  try {
    console.log('Connecting to database...');
    await client.connect();
    console.log('Connected!\n');

    // ============================================
    // MIGRATION 013: Add is_active to categories
    // ============================================
    console.log('=== MIGRATION 013: Add is_active to categories ===');

    // Check if column already exists
    const checkIsActive = await client.query(`
      SELECT column_name FROM information_schema.columns
      WHERE table_name = 'categories' AND column_name = 'is_active';
    `);

    if (checkIsActive.rows.length > 0) {
      console.log('Column is_active already exists in categories. Skipping...');
    } else {
      console.log('Adding is_active column to categories...');
      await client.query(`
        ALTER TABLE public.categories
        ADD COLUMN IF NOT EXISTS is_active BOOLEAN DEFAULT true NOT NULL;
      `);
      console.log('Column added!');

      console.log('Creating index...');
      await client.query(`
        CREATE INDEX IF NOT EXISTS idx_categories_is_active
        ON public.categories(user_id, is_active);
      `);
      console.log('Index created!');

      console.log('Updating existing categories to be active...');
      await client.query(`
        UPDATE public.categories
        SET is_active = true
        WHERE is_active IS NULL;
      `);
      console.log('Updated!');
    }

    // ============================================
    // MIGRATION 024: Add is_auto_generated to budgets
    // ============================================
    console.log('\n=== MIGRATION 024: Add is_auto_generated to budgets ===');

    // Check if column already exists
    const checkAutoGenerated = await client.query(`
      SELECT column_name FROM information_schema.columns
      WHERE table_name = 'budgets' AND column_name = 'is_auto_generated';
    `);

    if (checkAutoGenerated.rows.length > 0) {
      console.log('Column is_auto_generated already exists in budgets. Skipping...');
    } else {
      console.log('Adding is_auto_generated column to budgets...');
      await client.query(`
        ALTER TABLE public.budgets
        ADD COLUMN IF NOT EXISTS is_auto_generated BOOLEAN DEFAULT FALSE;
      `);
      console.log('Column added!');

      console.log('Setting is_auto_generated = true for existing auto-generated budgets...');
      await client.query(`
        UPDATE public.budgets
        SET is_auto_generated = TRUE
        WHERE source_type IN ('goal', 'debt', 'investment', 'credit_card')
          AND (is_auto_generated IS NULL OR is_auto_generated = FALSE);
      `);
      console.log('Updated!');

      console.log('Adding comment...');
      await client.query(`
        COMMENT ON COLUMN public.budgets.is_auto_generated IS
        'Flag indicating if budget was automatically generated from goals, debts, investments, or credit cards. These budgets cannot be manually edited.';
      `);
      console.log('Comment added!');

      console.log('Creating index...');
      await client.query(`
        CREATE INDEX IF NOT EXISTS idx_budgets_auto_generated
        ON public.budgets(user_id, is_auto_generated, source_type)
        WHERE is_auto_generated = TRUE;
      `);
      console.log('Index created!');
    }

    // ============================================
    // Verify migrations
    // ============================================
    console.log('\n=== Verifying migrations ===');

    const categoriesColumns = await client.query(`
      SELECT column_name, data_type, column_default
      FROM information_schema.columns
      WHERE table_name = 'categories' AND column_name = 'is_active';
    `);
    console.log('Categories is_active column:', categoriesColumns.rows);

    const budgetsColumns = await client.query(`
      SELECT column_name, data_type, column_default
      FROM information_schema.columns
      WHERE table_name = 'budgets' AND column_name = 'is_auto_generated';
    `);
    console.log('Budgets is_auto_generated column:', budgetsColumns.rows);

    console.log('\n=== All migrations completed successfully! ===');

  } catch (error) {
    console.error('Migration failed:', error.message);
    console.error(error.stack);
  } finally {
    await client.end();
  }
}

runMigrations();
